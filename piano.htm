<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        /* MONOCHROME: Dark grey background */
        background-color: #6b6b6b;
        font-family: sans-serif;
        margin: 0;
        color: white;
        flex-direction: column;
        overflow: hidden;
        user-select: none;
      }

      .wicki-board {
        position: relative;
        /* MONOCHROME: Slightly lighter grey for the board */
        background: #464646;
        padding: 60px 100px;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        zoom: 0.85;
      }

      .row {
        display: flex;
        margin-bottom: 15px; /* Vertical spacing kept at 15px */
      }

      /* --- CUSTOM ROW INDENTATION --- */
      /* CALCULATION FOR ALIGNMENT:
          Key Width (60px) + Key Margin (12px * 2 = 24px) = 84px Total Unit Width
          The offsets must be multiples of 84px to maintain the grid.
      */
      .row-4 {
        margin-left: -168px; /* -84 * 2 */
      }
      .row-3 {
        margin-left: -84px; /* -84 * 1 */
      }
      .row-2 {
        margin-left: 0px;
      }
      .row-1 {
        margin-left: 84px; /* 84 * 1 */
      }
      .row-0 {
        margin-left: 168px; /* 84 * 2 */
      }

      .key {
        /* BIGGER BUTTONS: Increased from 50px to 60px */
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 12px;
        cursor: pointer;
        position: relative;
        box-shadow: 0 5px 0 #000;
        transition: transform 0.05s, box-shadow 0.05s, background-color 0.1s;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        font-size: 18px; /* Increased font size for readability */
        font-weight: bold;

        /* --- STABILITY FIX --- */
        box-sizing: border-box;
        border: 2px solid transparent;
      }

      .key:active,
      .key.active {
        transform: translateY(5px);
        box-shadow: 0 0 0 #000;
      }

      /* WHITE KEYS */
      .key.natural {
        background: #aaaaaa;
        color: #000000;
      }
      .key.natural:active,
      .key.natural.active {
        background: #727272; /* Light grey when pressed */
        border-color: #101010;
      }

      /* BLACK KEYS */
      .key.accidental {
        background: #1f1f1f;
        color: #ffffff;
        border: 2px solid #555; /* Grey border to differentiate from background */
      }
      .key.accidental:active,
      .key.accidental.active {
        background: #333333; /* Dark grey when pressed */
        border-color: #777;
      }
    </style>
  </head>
  <title>Classical Piano</title>
  <body>
    <div class="wicki-board" id="board"></div>

    <script>
      const ROWS = 5;
      const COLS = 14;
      const BASE_NOTE_FREQ = 130.81;

      let globalTranspose = 3;

      const KEY_MAPS = [
        // Row 4 (Top Visual)
        [
          "Esc",
          "F1",
          "F2",
          "F3",
          "F4",
          "F5",
          "F6",
          "F7",
          "F8",
          "F9",
          "F10",
          "F11",
          "F12",
          "Delete",
        ],
        // Row 3 (Numbers) - Added Backspace
        [
          "`",
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
          "0",
          "-",
          "=",
          "Backspace",
        ],
        // Row 2 (Tab/QWERTY) - Added Backslash
        [
          "Tab",
          "q",
          "w",
          "e",
          "r",
          "t",
          "y",
          "u",
          "i",
          "o",
          "p",
          "[",
          "]",
          "\\",
        ],
        // Row 1 (Caps)
        [
          "CapsLock",
          "a",
          "s",
          "d",
          "f",
          "g",
          "h",
          "j",
          "k",
          "l",
          ";",
          "'",
          "Enter",
        ],
        // Row 0 (Shift)
        [
          "ShiftLeft",
          "z",
          "x",
          "c",
          "v",
          "b",
          "n",
          "m",
          ",",
          ".",
          "/",
          "ShiftRight",
          "Control",
        ],
      ];

      const board = document.getElementById("board");
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function renderBoard() {
        board.innerHTML = "";

        for (let r = 0; r < ROWS; r++) {
          const rowDiv = document.createElement("div");
          rowDiv.className = "row row-" + r;

          for (let c = 0; c < COLS; c++) {
            const mapRowIndex = ROWS - 1 - r;
            let keyMapChar = "";
            if (KEY_MAPS[mapRowIndex] && KEY_MAPS[mapRowIndex][c]) {
              keyMapChar = KEY_MAPS[mapRowIndex][c];
            }

            const isExplicitlyHidden = ["Esc", "Control", "`", "F1"].includes(
              keyMapChar
            );

            // Logic Update: Only trim the last column for the bottom 2 rows now (r=0 and r=1)
            // This allows Backspace (r=3) and Backslash (r=2) to appear in column 13.
            const isTrimmedEnd = r < 2 && c === COLS - 1;

            const isHidden = isExplicitlyHidden || isTrimmedEnd;

            // --- PITCH CALCULATION ---
            let semitoneOffset = r * 5 + c * 2 + globalTranspose;

            let freq = BASE_NOTE_FREQ * Math.pow(2, semitoneOffset / 12);

            let noteIndex = ((semitoneOffset % 12) + 12) % 12;
            let isNatural = [0, 2, 4, 5, 7, 9, 11].includes(noteIndex);

            const key = document.createElement("div");
            key.className = `key ${isNatural ? "natural" : "accidental"}`;
            key.setAttribute("data-note", freq);

            if (isHidden) {
              key.style.visibility = "hidden";
              key.style.pointerEvents = "none";
            }

            if (keyMapChar) {
              key.setAttribute("data-key", keyMapChar.toLowerCase());
            }

            key.addEventListener("mousedown", () => playKey(key));
            rowDiv.appendChild(key);
          }
          board.appendChild(rowDiv);
        }
      }

      /* * UPDATED SOUND ENGINE V5 - Safety Limiter Logic
       * - Fixed "Exploding Bass": Clamped volume significantly for low Hz.
       * - Fixed "Infinite Sustain": Hard capped duration to 4 seconds.
       */
      function playSound(frequency) {
        const now = audioCtx.currentTime;

        // 1. DURATION: Cap at 4 seconds.
        // Previously, low notes (e.g. 50Hz) would last 20 seconds (1000/50).
        let calculatedDuration = 1 + 500 / frequency;
        const duration = Math.min(calculatedDuration, 3);

        // 2. VOLUME:
        // We use a gentler curve and a strict hard cap.
        // Old formula: 30/freq (at 60hz this was 0.5, at 30hz this was 1.0)
        // New formula: 20/freq, but never go above 0.35 total gain.
        let volume = 15 / frequency;

        const masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);

        // ENVELOPE:
        masterGain.gain.setValueAtTime(0, now);
        masterGain.gain.linearRampToValueAtTime(volume, now + 0.015);

        // Decay to sustain level (sustain is 60% of max volume)
        masterGain.gain.exponentialRampToValueAtTime(volume * 0.6, now + 0.4);

        // Long release tail
        masterGain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

        // 3. FILTER (The Brightness)
        const filter = audioCtx.createBiquadFilter();
        filter.type = "lowpass";
        filter.Q.value = 0;
        filter.connect(masterGain);

        // Attack Brightness
        // We cap the attack brightness so deep bass doesn't "click" too hard
        const attackBrightness = Math.max(frequency * 8, 800);
        const sustainBrightness = frequency * 3;

        filter.frequency.setValueAtTime(attackBrightness, now);

        filter.frequency.exponentialRampToValueAtTime(
          sustainBrightness,
          now + 0.5
        );
        filter.frequency.linearRampToValueAtTime(frequency, now + duration);

        // 4. OSCILLATORS
        const osc1 = audioCtx.createOscillator();
        osc1.type = "sine";
        osc1.frequency.value = frequency;
        osc1.connect(filter);
        osc1.start(now);
        osc1.stop(now + duration + 0.1);

        const osc2 = audioCtx.createOscillator();
        osc2.type = "triangle";
        osc2.frequency.value = frequency;
        // Reduced detune slightly for cleaner bass
        osc2.detune.value = 2;
        osc2.connect(filter);
        osc2.start(now);
        osc2.stop(now + duration + 0.1);

        setTimeout(() => {
          masterGain.disconnect();
        }, (duration + 0.2) * 1000);
      }

      function playKey(keyElement) {
        if (!keyElement) return;
        if (keyElement.style.visibility === "hidden") return;

        keyElement.classList.add("active");
        setTimeout(() => keyElement.classList.remove("active"), 150);
        const noteFreq = keyElement.getAttribute("data-note");
        // Ensure we parse the float before sending it to audio
        playSound(parseFloat(noteFreq));
      }

      window.addEventListener("keydown", (e) => {
        // --- NAVIGATION CONTROLS ---
        if (e.key.startsWith("Arrow")) {
          if (e.repeat) return;

          if (e.key === "ArrowRight") globalTranspose += 5;
          else if (e.key === "ArrowLeft") globalTranspose -= 5;
          else if (e.key === "ArrowUp") globalTranspose += 12;
          else if (e.key === "ArrowDown") globalTranspose -= 12;

          renderBoard();
          return;
        }

        // --- ROBUST KEY DETECTION FIX ---
        let searchKey = e.key.toLowerCase();

        // Override for Shift keys to use their physical code
        if (e.code === "ShiftLeft" || e.code === "ShiftRight") {
          searchKey = e.code.toLowerCase();
        }

        const key = document.querySelector(
          `.key[data-key="${CSS.escape(searchKey)}"]`
        );

        if (key && key.style.visibility !== "hidden") {
          e.preventDefault();
          if (!e.repeat) {
            playKey(key);
          }
        }
      });

      renderBoard();
    </script>
  </body>
</html>
