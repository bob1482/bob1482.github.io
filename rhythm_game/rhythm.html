<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wicki-Hayden Web Synth</title>
    <!-- Tailwind CSS for layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: white;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; /* Prevent scrolling on mobile */
        }

        /* Canvas stays behind the keyboard */
        #visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #keyboard-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
        }

        /* Hexagon Logic */
        .hex-row {
            display: flex;
            justify-content: center;
            margin-top: -18px; /* Negative margin to nest hexagons */
        }

        /* Shift even rows to create the honeycomb pattern */
        .hex-row:nth-child(even) {
            transform: translateX(32px); 
        }

        .key {
            width: 60px;
            height: 70px;
            background-color: #334155; /* Slate 700 */
            margin: 2px;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .key:active, .key.active {
            background-color: #38bdf8; /* Sky 400 */
            transform: scale(0.95);
        }

        /* Color Coding for C Notes (Root) */
        .key.is-root {
            background-color: #6366f1; /* Indigo 500 */
        }
        
        /* Color Coding for Black Keys (Sharp/Flat visually distinct) */
        .key.is-accidental {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #475569;
        }

        .note-label {
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
        }
        
        .octave-label {
            font-size: 10px;
            opacity: 0.7;
            pointer-events: none;
        }

        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .glow-btn {
            background: linear-gradient(45deg, #ec4899, #8b5cf6);
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            color: white;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            transition: transform 0.2s;
        }
        
        .glow-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <!-- Start Screen Overlay -->
    <div id="start-overlay">
        <h1 class="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">
            Wicki-Hayden Synth
        </h1>
        <p class="mb-8 text-gray-300 max-w-md">
            An isomorphic hexagonal keyboard. <br>
            Right = Whole Tone. Up-Right = Perfect 5th.
        </p>
        <button class="glow-btn" id="start-btn">Click to Start</button>
    </div>

    <!-- Visualizer Canvas -->
    <canvas id="visualizer"></canvas>

    <!-- UI Controls -->
    <div class="absolute top-4 right-4 z-20 flex gap-2">
        <div class="bg-slate-800 p-2 rounded text-xs opacity-70">
            <div>Volume: <input type="range" id="vol-slider" min="-30" max="0" value="-10"></div>
        </div>
    </div>

    <!-- Keyboard Container -->
    <div id="keyboard-container">
        <div id="keyboard-grid" class="flex flex-col-reverse items-center">
            <!-- Keys generated by JS -->
        </div>
    </div>

<script>
    // --- Configuration ---
    // The Wicki-Hayden Layout Math
    // X-axis: +2 semitones
    // Y-axis (stacked rows): +7 semitones (Perfect 5th) usually, 
    // but in this hexagonal render, we need to map Row/Col to MIDI.
    
    // Grid size
    const ROWS = 6;
    const COLS = 9;
    const BASE_NOTE_MIDI = 36; // C2

    // Note names for display
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

    // State
    let isStarted = false;
    let synth = null;
    let activeNotes = new Set();
    
    // Visualizer State
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    let particles = [];

    // --- Audio Setup ---
    async function initAudio() {
        await Tone.start();
        
        // Create a PolySynth with a nice sound
        synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: {
                type: "triangle" // Softer than square, fuller than sine
            },
            envelope: {
                attack: 0.02,
                decay: 0.1,
                sustain: 0.3,
                release: 1
            }
        });

        // Add effects chain
        const filter = new Tone.Filter(800, "lowpass");
        const reverb = new Tone.Reverb({ decay: 2, wet: 0.4 });
        const comp = new Tone.Compressor(-30, 3);
        
        // Connect
        synth.chain(filter, reverb, comp, Tone.Destination);
        
        // Set initial volume
        Tone.Destination.volume.value = -10;
        
        isStarted = true;
        document.getElementById('start-overlay').style.display = 'none';
        
        // Start Animation Loop
        animate();
    }

    // --- Visualizer Logic ---
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.width = 40;
            this.height = 0; // Grows initially
            this.maxHeight = 60 + Math.random() * 40;
            this.speed = 3 + Math.random() * 2;
            this.color = color;
            this.life = 1.0;
            this.growing = true;
        }

        update() {
            // Move up
            this.y -= this.speed;
            
            // Effect: Grow then fade
            if(this.growing) {
                this.height += 5;
                if(this.height >= this.maxHeight) this.growing = false;
            }

            this.life -= 0.01;
        }

        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            
            // Draw a glowing bar
            ctx.shadowBlur = 15;
            ctx.shadowColor = this.color;
            ctx.fillRect(this.x - this.width/2, this.y, this.width, this.height);
            
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 1;
        }
    }

    function animate() {
        if(!isStarted) return;
        requestAnimationFrame(animate);

        // Clear with fade trail effect
        ctx.fillStyle = 'rgba(15, 23, 42, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.update();
            p.draw(ctx);
            if (p.life <= 0) {
                particles.splice(i, 1);
            }
        }
    }

    function spawnParticle(rect, noteIndex) {
        // Generate color based on note pitch
        const hue = (noteIndex * 20) % 360;
        const color = `hsl(${hue}, 80%, 60%)`;
        
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top; // Start at top of key
        
        particles.push(new Particle(centerX, centerY, color));
    }

    // --- Keyboard Generation ---

    function getMidiNote(row, col) {
        // Wicki-Hayden Logic:
        // C2 is at 0,0 (arbitrary starting point logic)
        // Row 0: Whole tone scale (0, 2, 4, 6...)
        // Row 1: Starts at P4 or P5 from Row 0. 
        // Standard Wicki layout: moving up a row (and slightly right visually) is +7 semitones (Perfect 5th)
        // moving directly right is +2 semitones.
        
        // Let's implement strict relation:
        // Note = Base + (Col * 2) + (Row * 7)
        // However, we shift even rows visually in CSS.
        // To align musically with the visual shift:
        // If we treat the grid as Cartesian, Wicki-Hayden is:
        // x = whole tone, y = perfect fifth.
        
        // Adjust for limited grid size to center C4 roughly
        let offset = -12; // Tuning
        return BASE_NOTE_MIDI + (col * 2) + (row * 7) + offset;
    }

    function createKeyboard() {
        const grid = document.getElementById('keyboard-grid');

        for (let r = ROWS - 1; r >= 0; r--) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'hex-row';
            
            for (let c = 0; c < COLS; c++) {
                const midi = getMidiNote(r, c);
                const noteNameIndex = midi % 12;
                const octave = Math.floor(midi / 12) - 1;
                const noteName = NOTE_NAMES[noteNameIndex];
                const fullNote = `${noteName}${octave}`;
                
                const key = document.createElement('div');
                key.className = 'key';
                key.dataset.note = fullNote;
                key.dataset.midi = midi;
                
                // Styling classes
                if (noteNameIndex === 0) key.classList.add('is-root'); // C
                if ([1, 3, 6, 8, 10].includes(noteNameIndex)) key.classList.add('is-accidental'); // Black keys

                key.innerHTML = `
                    <span class="note-label">${noteName}</span>
                    <span class="octave-label">${octave}</span>
                `;

                // Interaction Events
                const triggerNote = (e) => {
                    e.preventDefault();
                    if (!isStarted) return;
                    
                    if (!activeNotes.has(fullNote)) {
                        synth.triggerAttack(fullNote);
                        activeNotes.add(fullNote);
                        key.classList.add('active');
                        
                        // Visuals
                        const rect = key.getBoundingClientRect();
                        spawnParticle(rect, midi);
                    }
                };

                const releaseNote = (e) => {
                    e.preventDefault();
                    if (!isStarted) return;
                    
                    if (activeNotes.has(fullNote)) {
                        synth.triggerRelease(fullNote);
                        activeNotes.delete(fullNote);
                        key.classList.remove('active');
                    }
                };

                // Mouse
                key.addEventListener('mousedown', triggerNote);
                key.addEventListener('mouseup', releaseNote);
                key.addEventListener('mouseleave', releaseNote);

                // Touch
                key.addEventListener('touchstart', triggerNote, {passive: false});
                key.addEventListener('touchend', releaseNote);
                key.addEventListener('touchcancel', releaseNote);

                rowDiv.appendChild(key);
            }
            grid.appendChild(rowDiv);
        }
    }

    // --- Initialization ---
    document.getElementById('start-btn').addEventListener('click', initAudio);
    
    // Volume Control
    document.getElementById('vol-slider').addEventListener('input', (e) => {
        if(synth) Tone.Destination.volume.value = parseFloat(e.target.value);
    });

    createKeyboard();

</script>
</body>
</html>