<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Split Classical Piano (Wicki-Hayden)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéπ</text></svg>">
    
    <link rel="stylesheet" href="piano.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
  </head>
  <body>
    
    <canvas id="motion-background"></canvas>

    <div id="drop-zone">
      <div class="drop-text">DROP MIDI FILE HERE</div>
    </div>

    <div id="controls">
      <div class="control-group">
        <span class="control-label">Volume</span>
        <div class="btn-row">
          <button class="control-btn" onclick="changeVolume(-0.1)">-</button>
          <span class="control-val" id="disp-vol">50%</span>
          <button class="control-btn" onclick="changeVolume(0.1)">+</button>
        </div>
      </div>
      <div class="control-group">
        <span class="control-label">Sustain</span>
        <div class="btn-row">
          <button class="control-btn" onclick="changeSustain(-0.2)">-</button>
          <span class="control-val" id="disp-sus">1.0x</span>
          <button class="control-btn" onclick="changeSustain(0.2)">+</button>
        </div>
      </div>
      <div class="control-group">
        <span class="control-label">Labels</span>
        <button class="control-btn" style="width: 80px; font-size: 11px;" onclick="cycleLabels()" id="btn-labels">NOTES</button>
      </div>
      
      <div class="control-group">
        <span class="control-label">Sound</span>
        <button class="control-btn" style="width: 80px; font-size: 11px;" onclick="toggleSoundMode()" id="btn-sound">PIANO</button>
      </div>
      
      <div class="control-group">
        <span class="control-label">Board</span>
        <button class="control-btn" style="width: 80px; font-size: 11px;" onclick="toggleBoard()" id="btn-board">HIDE</button>
      </div>
      
      <div class="control-group">
        <span class="control-label">Shift</span>
        <button class="control-btn" style="width: 80px; font-size: 11px;" onclick="toggleShiftMode()" id="btn-shift">1 / 12</button>
      </div>
      
      <div class="control-group">
        <span class="control-label">F-Keys</span>
        <button class="control-btn" style="width: 80px; font-size: 11px;" onclick="toggleFKeys()" id="btn-fkeys">F3-F12</button>
      </div>
      
      <div class="control-group">
        <span class="control-label">Recorder</span>
        <div class="btn-row">
          <button class="control-btn" id="btn-record" onclick="toggleRecording()" title="Record">‚óè</button>
          <button class="control-btn" id="btn-play" onclick="togglePlayback()" title="Play">‚ñ∂</button>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">Metronome</span>
        <div class="btn-row">
          <button class="control-btn" id="btn-metro" onclick="toggleMetronome()" title="Toggle Click">M</button>
          <input type="number" id="input-bpm" value="120" onchange="updateBPM(this.value)" 
                 style="width: 40px; background: rgba(111,111,111,0.3); border: none; color: white; border-radius: 4px; padding: 4px; font-weight: bold; text-align: center;">
        </div>
      </div>
      
      <div class="control-group">
        <div style="display: flex; gap: 10px;">
          <div style="display:flex; flex-direction:column; align-items:center;">
            <span class="side-label">LEFT</span>
            <div class="btn-row">
              <button class="control-btn" onclick="changeTranspose('left', -1)">-</button>
              <span class="control-val" id="disp-trans-l">0</span>
              <button class="control-btn" onclick="changeTranspose('left', 1)">+</button>
            </div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:center;">
            <span class="side-label">RIGHT</span>
            <div class="btn-row">
              <button class="control-btn" onclick="changeTranspose('right', -1)">-</button>
              <span class="control-val" id="disp-trans-r">0</span>
              <button class="control-btn" onclick="changeTranspose('right', 1)">+</button>
            </div>
          </div>
        </div>
      </div>

     <div class="control-group" style="display: none;">
      <span class="side-label" style="margin-top: 5px;">transequence</span>
      <input type="text" id="input-sequence" 
             value="-5:-5 -12:0 5:5 12:12 -17:-17 17:5" 
             title="Format: 'L:R' (e.g., -12:0) or 'Both' (e.g., -12). Values are added to current transpose."
             style="width: 300px; background: #222; color: white; border: 1px solid #666; border-radius: 4px; padding: 4px; font-size: 11px; text-align: center;">
    </div>
    </div>

    <canvas id="synthesia-canvas"></canvas>

    <div id="board-wrapper">
      <div class="wicki-board" id="board-left"></div>
      <div class="wicki-board" id="board-right"></div>
    </div>

    <div id="piano-strip"></div>
    
    <script src="piano_core.js"></script>
    <script src="piano_visualizer.js"></script> 
    <script src="piano_render.js"></script> 
    <script src="piano_interaction.js"></script>
    <script src="piano_midi.js"></script>

    <script>
      (function() {
        const canvas = document.getElementById('motion-background');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        
        // Configuration
        const particleCount = 50; // Adjust for density
        const connectionDistance = 100; // Max distance to draw lines
        const moveSpeed = 1; // Speed of movement

        function resize() {
          width = canvas.width = window.innerWidth;
          height = canvas.height = window.innerHeight;
        }

        class Particle {
          constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * moveSpeed;
            this.vy = (Math.random() - 0.5) * moveSpeed;
            this.size = Math.random() * 2 + 3;
          }

          update() {
            this.x += this.vx;
            this.y += this.vy;

            // Bounce off edges
            if (this.x < 0 || this.x > width) this.vx *= -1;
            if (this.y < 0 || this.y > height) this.vy *= -1;
          }

          draw() {
            ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        function init() {
          particles = [];
          for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
          }
        }

        function animate() {
          ctx.clearRect(0, 0, width, height);

          // Update and Draw Particles
          for (let i = 0; i < particles.length; i++) {
            particles[i].update();
            particles[i].draw();

            // Draw Lines
            for (let j = i + 1; j < particles.length; j++) {
              const dx = particles[i].x - particles[j].x;
              const dy = particles[i].y - particles[j].y;
              const dist = Math.sqrt(dx * dx + dy * dy);

              if (dist < connectionDistance) {
                // Opacity based on distance (closer = more visible)
                const opacity = 1 - (dist / connectionDistance);
                ctx.strokeStyle = `rgba(150, 150, 150, ${opacity * 0.3})`; 
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(particles[i].x, particles[i].y);
                ctx.lineTo(particles[j].x, particles[j].y);
                ctx.stroke();
              }
            }
          }
          requestAnimationFrame(animate);
        }

        window.addEventListener('resize', () => {
          resize();
          init();
        });

        resize();
        init();
        animate();
      })();
    </script>
  </body>
</html>